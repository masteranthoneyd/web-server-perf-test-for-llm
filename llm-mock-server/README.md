# LLM Mock Server - é«˜å¹¶å‘æ¨¡æ‹ŸæœåŠ¡

ä¸€ä¸ªç”¨Rustç¼–å†™çš„é«˜æ€§èƒ½LLMæ…¢å“åº”æ¨¡æ‹ŸæœåŠ¡ï¼Œä¸“é—¨ç”¨äºå‹æµ‹LLMä¸šåŠ¡ç³»ç»Ÿï¼Œæ”¯æŒåœ¨1æ ¸1Gå’Œ2æ ¸2Gçš„èµ„æºé™åˆ¶ä¸‹å®ç°é«˜å¹¶å‘å¤„ç†ã€‚

## ğŸ†• æœ€æ–°åŠŸèƒ½
- **å®æ—¶å†…å­˜ç›‘æ§**ï¼šå¥åº·æ£€æŸ¥ç«¯ç‚¹ç°åœ¨è¿”å›è¯¦ç»†çš„ç³»ç»Ÿå†…å­˜ä¿¡æ¯
- **æ™ºèƒ½å¥åº·åˆ¤æ–­**ï¼šåŸºäºå¹¶å‘ä½¿ç”¨ç‡å’Œå†…å­˜ä½¿ç”¨ç‡çš„åŒé‡å¥åº·æ£€æŸ¥
- **å®Œæ•´ç›‘æ§æ”¯æŒ**ï¼šæ”¯æŒå¹¶å‘çŠ¶æ€ã€å†…å­˜çŠ¶æ€çš„å®æ—¶ç›‘æ§

## ğŸš€ æ€§èƒ½ä¼˜åŒ–äº®ç‚¹

### 1. **æ™ºèƒ½å¹¶å‘æ§åˆ¶**
- ä½¿ç”¨Tokioä¿¡å·é‡ç²¾ç¡®æ§åˆ¶æœ€å¤§å¹¶å‘æ•°
- 1æ ¸1Gé…ç½®ï¼šæ”¯æŒ1500+å¹¶å‘
- 2æ ¸2Gé…ç½®ï¼šæ”¯æŒ3000+å¹¶å‘
- è¶…å‡ºé™åˆ¶æ—¶è¿”å›503çŠ¶æ€ç ï¼Œé¿å…ç³»ç»Ÿå´©æºƒ

### 2. **èµ„æºä¼˜åŒ–é…ç½®**
- **å·¥ä½œçº¿ç¨‹æ•°æ™ºèƒ½è°ƒæ•´**ï¼š1æ ¸2çº¿ç¨‹ï¼Œ2æ ¸3çº¿ç¨‹
- **æ ˆå¤§å°ä¼˜åŒ–**ï¼š512KBçº¿ç¨‹æ ˆï¼ˆç›¸æ¯”é»˜è®¤2MBå¤§å¹…å‡å°‘ï¼‰
- **å†…å­˜é¢„åˆ†é…**ï¼šå“åº”ä½“å’Œå“åº”å¤´ä½¿ç”¨é™æ€åˆ†é…ï¼Œé›¶è¿è¡Œæ—¶å¼€é”€

### 3. **é›¶æˆæœ¬æŠ½è±¡**
- ä½¿ç”¨`static`å˜é‡é¢„åˆ†é…å“åº”å†…å®¹
- `Lazy`é™æ€åˆå§‹åŒ–å“åº”å¤´ï¼Œé¿å…é‡å¤åˆ›å»º
- ç¼–è¯‘æ—¶ä¼˜åŒ–ï¼Œè¿è¡Œæ—¶è¿‘ä¹é›¶å¼€é”€

### 4. **å®Œæ•´ç›‘æ§æ”¯æŒ**
- `/health` - å¥åº·æ£€æŸ¥ç«¯ç‚¹ï¼Œæ˜¾ç¤ºå¹¶å‘ä½¿ç”¨ç‡å’Œç³»ç»Ÿå†…å­˜çŠ¶æ€
- `/metrics` - Prometheusæ ¼å¼æŒ‡æ ‡
- å®æ—¶ç›‘æ§æ´»è·ƒè¯·æ±‚æ•°ã€å¯ç”¨æ§½ä½å’Œå†…å­˜ä½¿ç”¨æƒ…å†µ
- æ™ºèƒ½å¥åº·çŠ¶æ€åˆ¤æ–­ï¼šå¹¶å‘ä½¿ç”¨ç‡>90%æˆ–å†…å­˜ä½¿ç”¨ç‡>95%æ—¶è¿”å›ä¸å¥åº·çŠ¶æ€

### 5. **ç”Ÿäº§çº§ç‰¹æ€§**
- ä¼˜é›…å…³é—­ï¼šæ”¯æŒSIGTERMå’ŒSIGINTä¿¡å·
- TCPä¼˜åŒ–ï¼šå¯ç”¨keepaliveå’Œnodelay
- è¯·æ±‚ä½“å¤§å°é™åˆ¶ï¼š16KBé˜²æ­¢å†…å­˜æ”»å‡»
- érootç”¨æˆ·è¿è¡Œï¼šæé«˜å®‰å…¨æ€§

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

| é…ç½® | å¹¶å‘æ•° | å†…å­˜ä½¿ç”¨ | å·¥ä½œçº¿ç¨‹ | é€‚ç”¨åœºæ™¯ |
|------|--------|----------|----------|----------|
| 1æ ¸1G | 1500 | ~800MB | 2 | é«˜å¯†åº¦éƒ¨ç½² |
| 2æ ¸2G | 3000 | ~1.5GB | 3 | æ ‡å‡†éƒ¨ç½² |

å¯¹æ¯”ä¼ ç»ŸJava + Spring Bootï¼š
- **å¹¶å‘èƒ½åŠ›**ï¼šæå‡10-50å€
- **å†…å­˜æ•ˆç‡**ï¼šæ¯è¿æ¥ä»…éœ€2-8KBï¼ˆvs Javaçš„1-8MBï¼‰
- **å“åº”å»¶è¿Ÿ**ï¼šçº³ç§’çº§ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼ˆvs Javaçš„å¾®ç§’çº§ï¼‰

## ğŸ› ï¸ å¿«é€Ÿå¼€å§‹

### æœ¬åœ°è¿è¡Œ

```bash
# ç¼–è¯‘è¿è¡Œ
cargo run

# è‡ªå®šä¹‰é…ç½®
MAX_CONCURRENT=2000 WORKER_THREADS=2 cargo run

# ç¼–è¯‘
cargo build --release
```

### Dockeréƒ¨ç½²

```bash
# æ„å»ºé•œåƒ
docker build -t llm-mock-server .

# è¿è¡Œ1æ ¸1Gé…ç½®
docker compose up -d llm-mock-1c1g

# è¿è¡Œ2æ ¸2Gé…ç½®  
docker compose up -d llm-mock-2c2g
```

## ğŸ”§ é…ç½®å‚æ•°

| ç¯å¢ƒå˜é‡ | é»˜è®¤å€¼ | è¯´æ˜ |
|----------|--------|------|
| `MAX_CONCURRENT` | æ™ºèƒ½é…ç½® | æœ€å¤§å¹¶å‘è¯·æ±‚æ•° |
| `WORKER_THREADS` | æ™ºèƒ½é…ç½® | Tokioå·¥ä½œçº¿ç¨‹æ•° |
| `RESPONSE_DELAY_SECONDS` | 10 | å“åº”å»¶è¿Ÿç§’æ•° |
| `PORT` | 8080 | ç›‘å¬ç«¯å£ |

æ™ºèƒ½é»˜è®¤é…ç½®ï¼š
- 1æ ¸ï¼š1500å¹¶å‘ï¼Œ2å·¥ä½œçº¿ç¨‹
- 2æ ¸ï¼š3000å¹¶å‘ï¼Œ3å·¥ä½œçº¿ç¨‹

## ğŸ“‹ APIç«¯ç‚¹

### ä¸»è¦API
```bash
POST /compatible-mode/v1/chat/completions
Content-Type: application/json

{
  "model": "test",
  "messages": [{"role": "user", "content": "Hello"}]
}
```

### ç›‘æ§ç«¯ç‚¹
```bash
# å¥åº·æ£€æŸ¥
GET /health
# è¿”å›: 
{
  "status": "healthy",
  "concurrent_usage": "5.2%",
  "available_slots": 2844,
  "memory": {
    "total_mb": 46965,
    "used_mb": 1860,
    "available_mb": 45105,
    "usage_percent": "4.0%"
  }
}

# æŒ‡æ ‡ç›‘æ§  
GET /metrics
# è¿”å›Prometheusæ ¼å¼æŒ‡æ ‡
```

## ğŸ§ª å‹æµ‹ç¤ºä¾‹

```bash
# åŸºç¡€å‹æµ‹
curl -X POST http://localhost:8080/compatible-mode/v1/chat/completions \
     -H "Content-Type: application/json" \
     -d '{"model":"test","messages":[{"role":"user","content":"Hello"}]}'

# å¹¶å‘å‹æµ‹ï¼ˆä½¿ç”¨abï¼‰
ab -n 1000 -c 100 -p post_data.json -T application/json \
   http://localhost:8080/compatible-mode/v1/chat/completions

# ç›‘æ§å¹¶å‘ä½¿ç”¨ç‡å’Œå†…å­˜çŠ¶æ€
watch -n 1 'curl -s http://localhost:8080/health | jq .'

# ä»…ç›‘æ§å†…å­˜ä½¿ç”¨æƒ…å†µ
curl -s http://localhost:8080/health | jq '.memory'

# ç›‘æ§ç‰¹å®šæŒ‡æ ‡
curl -s http://localhost:8080/health | jq '.memory.usage_percent'
```

## ğŸ—ï¸ æ ¸å¿ƒæŠ€æœ¯æ¶æ„

### å¼‚æ­¥å¹¶å‘æ¨¡å‹
```
è¯·æ±‚ â†’ ä¿¡å·é‡æ§åˆ¶ â†’ å¼‚æ­¥å¤„ç† â†’ é™æ€å“åº” â†’ è¿”å›
```

### å†…å­˜ä½¿ç”¨ä¼˜åŒ–
- **é™æ€åˆ†é…**ï¼šå“åº”å†…å®¹ç¼–è¯‘æ—¶ç¡®å®š
- **é›¶æ‹·è´**ï¼šç›´æ¥è¿”å›é™æ€å­—ç¬¦ä¸²å¼•ç”¨
- **ç²¾ç¡®æ§åˆ¶**ï¼šä¿¡å·é‡ç¡®ä¿å†…å­˜ä½¿ç”¨ä¸Šé™

### çº¿ç¨‹æ¨¡å‹
```
å›ºå®šå·¥ä½œçº¿ç¨‹æ±  â†â†’ å¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ— â†â†’ äº‹ä»¶å¾ªç¯
```

## ğŸ“ˆ ç›‘æ§å’Œè°ƒä¼˜

### å…³é”®æŒ‡æ ‡

#### å¹¶å‘æŒ‡æ ‡
- `llm_mock_active_requests`ï¼šå½“å‰æ´»è·ƒè¯·æ±‚æ•°
- `llm_mock_max_concurrent_requests`ï¼šæœ€å¤§å¹¶å‘é™åˆ¶
- å¥åº·æ£€æŸ¥ä¸­çš„`concurrent_usage`ï¼šå¹¶å‘ä½¿ç”¨ç‡

#### å†…å­˜æŒ‡æ ‡ ğŸ†•
- `memory.total_mb`ï¼šç³»ç»Ÿæ€»å†…å­˜ï¼ˆMBï¼‰
- `memory.used_mb`ï¼šå·²ä½¿ç”¨å†…å­˜ï¼ˆMBï¼‰
- `memory.available_mb`ï¼šå¯ç”¨å†…å­˜ï¼ˆMBï¼‰
- `memory.usage_percent`ï¼šå†…å­˜ä½¿ç”¨ç‡ç™¾åˆ†æ¯”

#### å¥åº·çŠ¶æ€åˆ¤æ–­
æœåŠ¡ä¼šåœ¨ä»¥ä¸‹æƒ…å†µè¿”å›`SERVICE_UNAVAILABLE`çŠ¶æ€ï¼š
- å¹¶å‘ä½¿ç”¨ç‡ > 90% **æˆ–è€…**
- ç³»ç»Ÿå†…å­˜ä½¿ç”¨ç‡ > 95%

### è°ƒä¼˜å»ºè®®
1. **å†…å­˜ä¸è¶³**ï¼šå‡å°‘`MAX_CONCURRENT`ï¼Œç›‘æ§`memory.usage_percent`
2. **CPUç“¶é¢ˆ**ï¼šè°ƒæ•´`WORKER_THREADS`ï¼Œè§‚å¯Ÿå¹¶å‘å¤„ç†èƒ½åŠ›
3. **ç½‘ç»œå»¶è¿Ÿ**ï¼šæ£€æŸ¥TCPå‚æ•°å’Œç½‘ç»œé…ç½®
4. **å“åº”æ…¢**ï¼šå‡å°‘`RESPONSE_DELAY_SECONDS`ç”¨äºæµ‹è¯•
5. **èµ„æºé™åˆ¶æµ‹è¯•**ï¼šä½¿ç”¨Dockerä¸¥æ ¼é™åˆ¶CPUå’Œå†…å­˜èµ„æº

## ğŸ”’ å®‰å…¨ç‰¹æ€§

- érootç”¨æˆ·è¿è¡Œ
- è¯·æ±‚ä½“å¤§å°é™åˆ¶ï¼ˆ16KBï¼‰
- ä¼˜é›…å…³é—­ï¼Œé˜²æ­¢æ•°æ®ä¸¢å¤±
- å¥åº·æ£€æŸ¥é˜²æ­¢çº§è”æ•…éšœ

## ğŸ’¡ æœ€ä½³å®è·µ

1. **å®¹å™¨éƒ¨ç½²**ï¼šä½¿ç”¨docker-composeè¿›è¡Œèµ„æºé™åˆ¶
2. **ç›‘æ§é›†æˆ**ï¼šé…åˆPrometheus + Grafanaç›‘æ§
3. **è´Ÿè½½å‡è¡¡**ï¼šå¤šå®ä¾‹éƒ¨ç½²æé«˜å¯ç”¨æ€§
4. **å‹æµ‹ç­–ç•¥**ï¼šé€æ­¥å¢åŠ å¹¶å‘ï¼Œè§‚å¯Ÿç³»ç»Ÿè¡¨ç°
5. **å†…å­˜ç›‘æ§**ï¼šå®æ—¶ç›‘æ§`memory.usage_percent`ï¼Œé¿å…å†…å­˜æº¢å‡º
6. **å¥åº·æ£€æŸ¥**ï¼šé›†æˆåˆ°è´Ÿè½½å‡è¡¡å™¨ï¼Œè‡ªåŠ¨å‰”é™¤ä¸å¥åº·å®ä¾‹
7. **èµ„æºé™åˆ¶æµ‹è¯•**ï¼šä½¿ç”¨å®¹å™¨ä¸¥æ ¼é™åˆ¶èµ„æºï¼ŒéªŒè¯çœŸå®æ€§èƒ½

### å‹æµ‹å»ºè®® ğŸ†•
```bash
# 1. å¯åŠ¨æœåŠ¡å¹¶ç›‘æ§
./target/release/llm-mock-server &
watch -n 1 'curl -s http://localhost:8080/health'

# 2. é€æ­¥å¢åŠ å¹¶å‘å‹æµ‹
for concurrent in 100 500 1000 1500 2000; do
  echo "æµ‹è¯• $concurrent å¹¶å‘..."
  ab -n $concurrent -c $concurrent -s 30 \
     -p post_data.json -T application/json \
     http://localhost:8080/compatible-mode/v1/chat/completions
  
  # æ£€æŸ¥å†…å­˜ä½¿ç”¨æƒ…å†µ
  curl -s http://localhost:8080/health | jq '.memory.usage_percent'
  sleep 5
done
```

## ğŸ¯ å®é™…ä½¿ç”¨åœºæ™¯

### 1æ ¸1Gèµ„æºé™åˆ¶å‹æµ‹
```bash
# å¯åŠ¨å—é™æœåŠ¡ï¼ˆDockeræ–¹å¼ï¼‰
docker run --cpus="1.0" --memory="1g" -p 8080:8080 llm-mock-server

# ç›‘æ§å†…å­˜ä½¿ç”¨æƒ…å†µ
curl -s http://localhost:8080/health | jq '{
  status: .status,
  concurrent: .concurrent_usage,
  memory_mb: .memory.used_mb,
  memory_percent: .memory.usage_percent
}'

# è¾“å‡ºç¤ºä¾‹:
# {
#   "status": "healthy",
#   "concurrent": "45.2%",
#   "memory_mb": 856,
#   "memory_percent": "83.6%"
# }
```

### å‹æµ‹åœºæ™¯ä¸‹çš„å†…å­˜é¢„è­¦
```bash
# å½“å†…å­˜ä½¿ç”¨ç‡è¶…è¿‡95%æ—¶ï¼ŒæœåŠ¡è‡ªåŠ¨è¿”å›503çŠ¶æ€
curl -s http://localhost:8080/health | jq '.status'
# è¿”å›: "overloaded"

# é€‚åˆé›†æˆåˆ°ç›‘æ§å‘Šè­¦ç³»ç»Ÿ
if [ "$(curl -s http://localhost:8080/health | jq -r '.memory.usage_percent | tonumber')" -gt 90 ]; then
  echo "âš ï¸ å†…å­˜ä½¿ç”¨ç‡è¶…è¿‡90%ï¼Œè¯·æ³¨æ„ï¼"
fi
```

è¿™ä¸ªä¼˜åŒ–åçš„æœåŠ¡ç›¸æ¯”åŸç‰ˆæœ¬ï¼Œåœ¨ç›¸åŒèµ„æºä¸‹èƒ½å¤„ç†æ•°åå€çš„å¹¶å‘è¯·æ±‚ï¼Œå¹¶æä¾›å®Œæ•´çš„å†…å­˜ç›‘æ§åŠŸèƒ½ï¼Œæ˜¯è¿›è¡ŒLLMç³»ç»Ÿå‹æµ‹çš„ç†æƒ³é€‰æ‹©ã€‚ 